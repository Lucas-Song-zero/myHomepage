<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>åšå®¢ç¼–è¾‘å™¨</title>
    <link rel="icon" type="image/x-icon" href="/static/images/favicon.ico">
    <!-- Marked.js -->
    <script src="https://cdn.jsdelivr.net/npm/marked@11.1.1/marked.min.js"></script>
    <!-- KaTeX -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.css">
    <script src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.js"></script>
    <!-- Highlight.js -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/highlightjs/cdn-release@11.9.0/build/styles/github.min.css">
    <script src="https://cdn.jsdelivr.net/gh/highlightjs/cdn-release@11.9.0/build/highlight.min.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #f5f5f5;
            height: 100vh;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }
        
        /* ä¸ŠåŠéƒ¨åˆ†ï¼šå›ºå®šé«˜åº¦ */
        .top-section {
            background: white;
            padding: 20px;
            border-bottom: 2px solid #ddd;
            overflow-y: auto;
            max-height: 35vh;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
        }
        
        h1 {
            margin-bottom: 20px;
            color: #333;
        }
        
        .button-group {
            margin-bottom: 20px;
            padding-bottom: 20px;
            border-bottom: 2px solid #eee;
            display: flex;
            gap: 10px;
            align-items: center;
        }
        
        .file-input-wrapper {
            position: relative;
            overflow: hidden;
            display: inline-block;
        }
        
        .file-input-wrapper input[type=file] {
            position: absolute;
            left: -9999px;
        }
        
        .file-input-label {
            display: inline-block;
            padding: 10px 20px;
            background: #4ecdc4;
            color: white;
            border-radius: 0;
            cursor: pointer;
            font-weight: 500;
            font-size: 14px;
            transition: all 0.3s ease;
        }
        
        .file-input-label:hover {
            background: #45b8af;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(78, 205, 196, 0.3);
        }
        
        .form-group {
            margin-bottom: 15px;
        }
        
        .form-row {
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: 15px;
        }
        
        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: #666;
            font-size: 14px;
        }
        
        input[type="text"], textarea {
            width: 100%;
            padding: 10px;
            border: 2px solid #ddd;
            border-radius: 0;
            font-size: 14px;
            font-family: inherit;
        }
        
        /* ä¸‹åŠéƒ¨åˆ†ï¼šç¼–è¾‘å™¨åŒºåŸŸ */
        .bottom-section {
            flex: 1;
            background: #f5f5f5;
            padding: 20px;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }
        
        .bottom-section .container {
            max-width: none;
            width: 100%;
        }
        
        .editor-preview {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            height: 100%;
            overflow: hidden;
            width: 100%;
        }
        
        .editor-container {
            display: flex;
            flex-direction: column;
            height: 100%;
            overflow: hidden;
        }
        
        .editor-container label {
            margin-bottom: 10px;
            font-weight: 500;
            color: #666;
        }
        
        #content {
            width: 100%;
            height: 100%;
            border: 2px solid #ddd;
            border-radius: 0;
            font-size: 14px;
            font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
            padding: 15px;
            resize: none;
            background: white;
        }
        
        #content:focus {
            outline: none;
            border-color: #667eea;
        }
        
        #preview {
            background: white;
            padding: 20px;
            border-radius: 0;
            height: 100%;
            overflow-y: auto;
            border: 2px solid #ddd;
        }
        
        /* Markdowné¢„è§ˆæ ·å¼ */
        #preview h1, #preview h2, #preview h3 { margin-top: 1em; margin-bottom: 0.5em; }
        #preview p { margin-bottom: 1em; line-height: 1.6; }
        #preview code { background: #f4f4f4; padding: 2px 6px; border-radius: 0; }
        #preview pre { background: #f4f4f4; padding: 15px; border-radius: 0; overflow-x: auto; }
        #preview pre code { background: none; padding: 0; }
        #preview img { max-width: 100%; border-radius: 0; }
        #preview blockquote { border-left: 4px solid #ddd; padding-left: 1em; color: #666; }
        #preview ul, #preview ol { margin-left: 2em; margin-bottom: 1em; }
        #preview table { border-collapse: collapse; width: 100%; margin-bottom: 1em; }
        #preview th, #preview td { border: 1px solid #ddd; padding: 8px; text-align: left; }
        
        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 0;
            cursor: pointer;
            font-weight: 500;
            font-size: 16px;
            transition: all 0.3s ease;
        }
        
        .btn-primary {
            background: #667eea;
            color: white;
        }
        
        .btn-primary:hover {
            background: #5568d3;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
        }
        
        .btn-secondary {
            background: #95a5a6;
            color: white;
        }
        
        .btn-secondary:hover {
            background: #7f8c8d;
        }
        
        @media (max-width: 1200px) {
            .editor-preview {
                grid-template-columns: 1fr;
            }
            .form-row {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <!-- ä¸ŠåŠéƒ¨åˆ†ï¼šæŒ‰é’®å’Œè¡¨å• -->
    <div class="top-section">
        <div class="container">
            <div style="margin-bottom: 15px;">
                <a href="/index.html" style="text-decoration: none; color: #667eea; font-weight: 500;">ğŸ  ä¸»é¡µ</a>
                <span style="margin: 0 8px; color: #ccc;">|</span>
                <a href="/blog.html" style="text-decoration: none; color: #667eea; font-weight: 500;">â† è¿”å›åšå®¢åˆ—è¡¨</a>
            </div>
            <h1>åšå®¢ç¼–è¾‘å™¨</h1>
            <div class="button-group">
                <button class="btn btn-primary" onclick="saveBlog()">å‘å¸ƒåšå®¢</button>
                <button class="btn btn-secondary" onclick="history.back()">å–æ¶ˆ</button>
                <div class="file-input-wrapper">
                    <input type="file" id="imageInput" accept="image/*" onchange="uploadImage()" />
                    <label for="imageInput" class="file-input-label">æ’å…¥å›¾ç‰‡</label>
                </div>
            </div>
            <div class="form-group">
                <label for="title">æ ‡é¢˜ *</label>
                <input type="text" id="title" required>
            </div>
            <div class="form-row">
                <div class="form-group">
                    <label for="summary">æ‘˜è¦</label>
                    <textarea id="summary" rows="2"></textarea>
                </div>
                <div class="form-group">
                    <label for="tags">æ ‡ç­¾ï¼ˆé€—å·åˆ†éš”ï¼‰</label>
                    <input type="text" id="tags" placeholder="æŠ€æœ¯, Python, Flask">
                </div>
            </div>
            <div class="form-group">
                <label for="thumbnail">å°é¢å›¾ç‰‡</label>
                <div style="display: flex; gap: 10px; align-items: center;">
                    <input type="text" id="thumbnail" placeholder="å°é¢å›¾ç‰‡URLï¼ˆå¯é€‰ï¼‰" readonly style="flex: 1;">
                    <div class="file-input-wrapper">
                        <input type="file" id="thumbnailInput" accept="image/*" onchange="uploadThumbnail()" />
                        <label for="thumbnailInput" class="file-input-label" style="margin: 0; padding: 10px 16px; font-size: 14px;">ä¸Šä¼ å°é¢</label>
                    </div>
                    <button type="button" onclick="clearThumbnail()" class="btn" style="padding: 10px 16px; background: #e74c3c; color: white;">æ¸…é™¤</button>
                </div>
                <div id="thumbnailPreview" style="margin-top: 10px; display: none;">
                    <img id="thumbnailImg" src="" alt="å°é¢é¢„è§ˆ" style="max-width: 200px; max-height: 150px; border-radius: 0; border: 2px solid #ddd;">
                </div>
            </div>
        </div>
    </div>
    
    <!-- ä¸‹åŠéƒ¨åˆ†ï¼šç¼–è¾‘å™¨å’Œé¢„è§ˆ -->
    <div class="bottom-section">
        <div class="container" style="height: 100%; display: flex; flex-direction: column;">
            <div class="editor-preview">
                <div class="editor-container">
                    <label>Markdownå†…å®¹</label>
                    <textarea id="content"></textarea>
                </div>
                <div class="editor-container">
                    <label>å®æ—¶é¢„è§ˆ</label>
                    <div id="preview"></div>
                </div>
            </div>
        </div>
    </div>
    <script>
        // æ£€æŸ¥ç™»å½•çŠ¶æ€
        async function checkLogin() {
            try {
                const response = await fetch('/api/admin/check');
                const data = await response.json();
                
                if (!data.logged_in) {
                    alert('è¯·å…ˆç™»å½•ï¼');
                    window.location.href = '/admin_login.html';
                    return false;
                }
                return true;
            } catch (error) {
                console.error('æ£€æŸ¥ç™»å½•å¤±è´¥:', error);
                window.location.href = '/admin_login.html';
                return false;
            }
        }

        // é¡µé¢åŠ è½½æ—¶æ£€æŸ¥ç™»å½•
        document.addEventListener('DOMContentLoaded', async function() {
            await checkLogin();
            
            // ç›‘å¬å†…å®¹å˜åŒ–ï¼Œå®æ—¶é¢„è§ˆ
            const contentEditor = document.getElementById('content');
            contentEditor.addEventListener('input', function() {
                renderPreview();
            });

            // æ£€æŸ¥æ˜¯å¦æ˜¯ç¼–è¾‘æ¨¡å¼
            const urlParams = new URLSearchParams(window.location.search);
            const blogId = urlParams.get('id');
            if (blogId) {
                loadBlog(blogId);
            }
        });

        // åŠ è½½åšå®¢æ•°æ®ï¼ˆç¼–è¾‘æ¨¡å¼ï¼‰
        async function loadBlog(id) {
            try {
                const response = await fetch(`/api/blog/posts/${id}`);
                const data = await response.json();
                
                if (response.ok) {
                    // å¡«å……è¡¨å•
                    document.getElementById('title').value = data.title || '';
                    document.getElementById('summary').value = data.summary || '';
                    document.getElementById('content').value = data.content || '';
                    document.getElementById('tags').value = data.tags ? data.tags.join(', ') : '';
                    document.getElementById('thumbnail').value = data.thumbnail || '';
                    
                    // æ˜¾ç¤ºå°é¢é¢„è§ˆ
                    if (data.thumbnail) {
                        const preview = document.getElementById('thumbnailPreview');
                        const img = document.getElementById('thumbnailImg');
                        img.src = data.thumbnail;
                        preview.style.display = 'block';
                    }
                    
                    // æ›´æ–°é¢„è§ˆ
                    renderPreview();
                    
                    // ä¿®æ”¹æ ‡é¢˜å’ŒæŒ‰é’®æ–‡å­—
                    document.querySelector('h1').textContent = 'ç¼–è¾‘åšå®¢';
                    document.querySelector('.btn-primary').textContent = 'æ›´æ–°åšå®¢';
                } else {
                    alert('åŠ è½½åšå®¢å¤±è´¥: ' + (data.error || 'æœªçŸ¥é”™è¯¯'));
                    window.location.href = '/admin_panel.html';
                }
            } catch (error) {
                console.error('åŠ è½½åšå®¢å¤±è´¥:', error);
                alert('åŠ è½½åšå®¢å¤±è´¥: ' + error.message);
                window.location.href = '/admin_panel.html';
            }
        }

        // ä¸Šä¼ å›¾ç‰‡
        async function uploadImage() {
            const fileInput = document.getElementById('imageInput');
            const file = fileInput.files[0];
            
            if (!file) return;
            
            // æ£€æŸ¥æ–‡ä»¶ç±»å‹
            if (!file.type.startsWith('image/')) {
                alert('è¯·é€‰æ‹©å›¾ç‰‡æ–‡ä»¶ï¼');
                return;
            }
            
            // æ£€æŸ¥æ–‡ä»¶å¤§å°ï¼ˆé™åˆ¶5MBï¼‰
            if (file.size > 5 * 1024 * 1024) {
                alert('å›¾ç‰‡å¤§å°ä¸èƒ½è¶…è¿‡5MBï¼');
                return;
            }
            
            const formData = new FormData();
            formData.append('image', file);
            
            try {
                // æ˜¾ç¤ºä¸Šä¼ æç¤º
                const label = document.querySelector('.file-input-label');
                const originalText = label.textContent;
                label.textContent = 'ä¸Šä¼ ä¸­...';
                label.style.pointerEvents = 'none';
                
                const response = await fetch('/api/blog/admin/upload-image', {
                    method: 'POST',
                    body: formData
                });
                
                const result = await response.json();
                
                if (response.ok) {
                    // æ’å…¥å›¾ç‰‡åˆ°ç¼–è¾‘å™¨
                    insertImageToEditor(result.url);
                    alert('å›¾ç‰‡ä¸Šä¼ æˆåŠŸï¼');
                } else {
                    alert('ä¸Šä¼ å¤±è´¥: ' + (result.error || 'æœªçŸ¥é”™è¯¯'));
                }
                
                // æ¢å¤æŒ‰é’®
                label.textContent = originalText;
                label.style.pointerEvents = 'auto';
                
            } catch (error) {
                console.error('ä¸Šä¼ å¤±è´¥:', error);
                alert('ä¸Šä¼ å¤±è´¥: ' + error.message);
                
                // æ¢å¤æŒ‰é’®
                const label = document.querySelector('.file-input-label');
                label.textContent = 'æ’å…¥å›¾ç‰‡';
                label.style.pointerEvents = 'auto';
            }
            
            // æ¸…ç©ºinputï¼Œå…è®¸é‡å¤ä¸Šä¼ åŒä¸€æ–‡ä»¶
            fileInput.value = '';
        }
        
        // ä¸Šä¼ å°é¢å›¾ç‰‡
        async function uploadThumbnail() {
            const fileInput = document.getElementById('thumbnailInput');
            const file = fileInput.files[0];
            
            if (!file) return;
            
            // æ£€æŸ¥æ–‡ä»¶ç±»å‹
            if (!file.type.startsWith('image/')) {
                alert('è¯·é€‰æ‹©å›¾ç‰‡æ–‡ä»¶ï¼');
                return;
            }
            
            // æ£€æŸ¥æ–‡ä»¶å¤§å°ï¼ˆé™åˆ¶5MBï¼‰
            if (file.size > 5 * 1024 * 1024) {
                alert('å›¾ç‰‡å¤§å°ä¸èƒ½è¶…è¿‡5MBï¼');
                return;
            }
            
            const formData = new FormData();
            formData.append('image', file);
            
            try {
                // æ˜¾ç¤ºä¸Šä¼ æç¤º
                const label = document.querySelector('label[for="thumbnailInput"]');
                const originalText = label.textContent;
                label.textContent = 'ä¸Šä¼ ä¸­...';
                label.style.pointerEvents = 'none';
                
                const response = await fetch('/api/blog/admin/upload-image', {
                    method: 'POST',
                    body: formData
                });
                
                const result = await response.json();
                
                if (response.ok) {
                    // è®¾ç½®å°é¢URL
                    document.getElementById('thumbnail').value = result.url;
                    
                    // æ˜¾ç¤ºé¢„è§ˆ
                    const preview = document.getElementById('thumbnailPreview');
                    const img = document.getElementById('thumbnailImg');
                    img.src = result.url;
                    preview.style.display = 'block';
                    
                    alert('å°é¢ä¸Šä¼ æˆåŠŸï¼');
                } else {
                    alert('ä¸Šä¼ å¤±è´¥: ' + (result.error || 'æœªçŸ¥é”™è¯¯'));
                }
                
                // æ¢å¤æŒ‰é’®
                label.textContent = originalText;
                label.style.pointerEvents = 'auto';
                
            } catch (error) {
                console.error('ä¸Šä¼ å¤±è´¥:', error);
                alert('ä¸Šä¼ å¤±è´¥: ' + error.message);
                
                // æ¢å¤æŒ‰é’®
                const label = document.querySelector('label[for="thumbnailInput"]');
                label.textContent = 'ä¸Šä¼ å°é¢';
                label.style.pointerEvents = 'auto';
            }
            
            // æ¸…ç©ºinput
            fileInput.value = '';
        }
        
        // æ¸…é™¤å°é¢
        function clearThumbnail() {
            document.getElementById('thumbnail').value = '';
            document.getElementById('thumbnailPreview').style.display = 'none';
            document.getElementById('thumbnailImg').src = '';
        }
        
        // æ’å…¥å›¾ç‰‡åˆ°ç¼–è¾‘å™¨
        function insertImageToEditor(imageUrl) {
            const editor = document.getElementById('content');
            const cursorPos = editor.selectionStart;
            const textBefore = editor.value.substring(0, cursorPos);
            const textAfter = editor.value.substring(editor.selectionEnd);
            
            // æ„å»ºMarkdownå›¾ç‰‡è¯­æ³•
            const imageMarkdown = `![å›¾ç‰‡æè¿°](${imageUrl})`;
            
            // æ’å…¥åˆ°å…‰æ ‡ä½ç½®
            editor.value = textBefore + imageMarkdown + textAfter;
            
            // è®¾ç½®å…‰æ ‡ä½ç½®åˆ°å›¾ç‰‡æè¿°å¤„ï¼Œæ–¹ä¾¿ç”¨æˆ·ä¿®æ”¹
            const newCursorPos = cursorPos + 2; // å…‰æ ‡æ”¾åœ¨"å›¾ç‰‡æè¿°"çš„å¼€å§‹ä½ç½®
            editor.setSelectionRange(newCursorPos, newCursorPos + 4); // é€‰ä¸­"å›¾ç‰‡æè¿°"
            editor.focus();
            
            // æ›´æ–°é¢„è§ˆ
            renderPreview();
        }

        // æ¸²æŸ“é¢„è§ˆ
        function renderPreview() {
            const content = document.getElementById('content').value;
            let markdown = content;
            
            // ä¿æŠ¤å…¬å¼
            const mathBlocks = [];
            const mathInlines = [];
            
            markdown = markdown.replace(/\$\$([\s\S]+?)\$\$/g, (match, formula) => {
                mathBlocks.push(formula);
                return `MATHBLOCK${mathBlocks.length - 1}MATHBLOCK`;
            });
            
            markdown = markdown.replace(/\$(.+?)\$/g, (match, formula) => {
                mathInlines.push(formula);
                return `MATHINLINE${mathInlines.length - 1}MATHINLINE`;
            });
            
            // æ¸²æŸ“Markdown
            let html = marked.parse(markdown);
            
            // æ¢å¤å…¬å¼
            html = html.replace(/MATHBLOCK(\d+)MATHBLOCK/g, (match, index) => {
                return `<div class="math-block">$$${mathBlocks[index]}$$</div>`;
            });
            
            html = html.replace(/MATHINLINE(\d+)MATHINLINE/g, (match, index) => {
                return `<span class="math-inline">$${mathInlines[index]}$</span>`;
            });
            
            // å¤„ç†Bilibiliè§†é¢‘
            html = html.replace(/<code>(BV[a-zA-Z0-9]+)<\/code>/g, (match, bvid) => {
                return `<div class="bilibili-video" style="position: relative; padding-bottom: 56.25%; height: 0; margin: 20px 0;">
                    <iframe src="//player.bilibili.com/player.html?isOutside=true&bvid=${bvid}&autoplay=0" 
                        style="position: absolute; top: 0; left: 0; width: 100%; height: 100%;" 
                        frameborder="0" allowfullscreen></iframe>
                </div>`;
            });
            
            document.getElementById('preview').innerHTML = html;
            
            // æ¸²æŸ“KaTeXå…¬å¼
            document.querySelectorAll('.math-block').forEach(el => {
                const formula = el.textContent.replace(/^\$\$/, '').replace(/\$\$$/, '');
                try {
                    katex.render(formula, el, { displayMode: true, throwOnError: false });
                } catch(e) { console.error('KaTeXæ¸²æŸ“é”™è¯¯:', e); }
            });
            
            document.querySelectorAll('.math-inline').forEach(el => {
                const formula = el.textContent.replace(/^\$/, '').replace(/\$$/, '');
                try {
                    katex.render(formula, el, { displayMode: false, throwOnError: false });
                } catch(e) { console.error('KaTeXæ¸²æŸ“é”™è¯¯:', e); }
            });
            
            // ä»£ç é«˜äº®
            document.querySelectorAll('pre code').forEach(block => {
                hljs.highlightElement(block);
            });
        }
        
        async function saveBlog() {
            // éªŒè¯å¿…å¡«å­—æ®µ
            const title = document.getElementById('title').value.trim();
            if (!title) {
                alert('è¯·è¾“å…¥æ ‡é¢˜ï¼');
                return;
            }

            const content = document.getElementById('content').value.trim();
            if (!content) {
                alert('è¯·è¾“å…¥å†…å®¹ï¼');
                return;
            }

            const data = {
                title: title,
                summary: document.getElementById('summary').value.trim(),
                content: content,
                thumbnail: document.getElementById('thumbnail').value.trim(),
                tags: document.getElementById('tags').value.split(',').map(t => t.trim()).filter(t => t),
                is_published: true
            };
            
            // æ£€æŸ¥æ˜¯å¦æ˜¯ç¼–è¾‘æ¨¡å¼
            const urlParams = new URLSearchParams(window.location.search);
            const blogId = urlParams.get('id');
            
            try {
                let url = '/api/blog/admin/posts';
                let method = 'POST';
                
                // å¦‚æœæ˜¯ç¼–è¾‘æ¨¡å¼ï¼Œä½¿ç”¨PUTæ–¹æ³•
                if (blogId) {
                    url = `/api/blog/admin/posts/${blogId}`;
                    method = 'PUT';
                }
                
                const response = await fetch(url, {
                    method: method,
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });
                
                const result = await response.json();
                
                if (response.ok) {
                    alert(blogId ? 'æ›´æ–°æˆåŠŸï¼' : 'å‘å¸ƒæˆåŠŸï¼');
                    window.location.href = '/admin_panel.html';
                } else {
                    alert('æ“ä½œå¤±è´¥: ' + (result.error || 'æœªçŸ¥é”™è¯¯'));
                }
            } catch (error) {
                console.error('ä¿å­˜å¤±è´¥:', error);
                alert('ä¿å­˜å¤±è´¥: ' + error.message);
            }
        }
    </script>
        <footer style="display:flex;justify-content:center;padding:10px 16px;background:rgba(255,255,255,0.9);border-top:1px solid rgba(0,0,0,0.06);font-size:0.85rem;">
            <a href="https://beian.mps.gov.cn/#/query/webSearch?code=11010802047067" rel="noreferrer" target="_blank" style="display:inline-flex;align-items:center;gap:8px;color:inherit;text-decoration:none">
                <img src="/static/images/police.png" alt="police" style="height:18px;display:inline-block">
                <span>äº¬å…¬ç½‘å®‰å¤‡11010802047067å·</span>
            </a>
        </footer>
    </body>
    </html>
