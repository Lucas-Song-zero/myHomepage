name: Deploy homepage

on:
  push:
    branches: [ "master" ]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: self-hosted
    steps:
      - name: Deploy via remote workdir
        env:
          HOST: ${{ secrets.HOST }}
          WORKDIR: ${{ secrets.WORKDIR }}
          SERVICENAME: ${{ secrets.SERVICENAME }}
        shell: bash
        run: |
          set -euo pipefail

          echo "HOST=$HOST"
          echo "WORKDIR=$WORKDIR"
          echo "SERVICENAME=$SERVICENAME"

          if [ ! -d "$WORKDIR" ]; then
            echo "ERROR: WORKDIR does not exist: $WORKDIR"
            exit 1
          fi

          cd "$WORKDIR"

          echo "Updating git repo..."
          # 可选：确保不会因为 ownership 触发 safe.directory 报错
          git config --global --add safe.directory "$WORKDIR" || true

          git fetch --all --prune
          git checkout master
          git pull origin master

          cd "$(dirname "$WORKDIR")"

          echo "Build python dependency"
          python3 -m venv venv
          source venv/bin/activate

          pip install -r "$WORKDIR/requirements.txt" -q
          pip install gunicorn -q

          echo "Restarting service $SERVICENAME"
          sudo systemctl restart "$SERVICENAME"

          echo "Deployment completed, visit https://$HOST"