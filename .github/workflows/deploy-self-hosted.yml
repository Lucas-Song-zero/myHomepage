name: Deploy homepage

on:
  push:
    branches: [ "master" ]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: self-hosted
    steps:
      - name: Deploy via remote workdir
        env:
          HOST: ${{ secrets.HOST }}
          WORKDIR: ${{ secrets.WORKDIR }}
          SERVICENAME: ${{ secrets.SERVICENAME }}
          RUNNER_PASSWORD: ${{ secrets.RUNNER }}
        shell: bash
        run: |
          set -euo pipefail

          echo "HOST=$HOST"
          echo "WORKDIR=$WORKDIR"
          echo "SERVICENAME=$SERVICENAME"

          if [ ! -d "$WORKDIR" ]; then
            echo "ERROR: WORKDIR does not exist: $WORKDIR"
            exit 1
          fi

          cd "$WORKDIR"

          echo "Updating git repo..."
          # 可选：确保不会因为 ownership 触发 safe.directory 报错
          git config --global --add safe.directory "$WORKDIR" || true

          git fetch --all --prune
          git checkout master
          git pull origin master

          echo "Setting up Python virtual environment..."
          if [ ! -d "venv" ]; then
            echo "Creating new virtual environment..."
            python3 -m venv venv
          fi
          
          source venv/bin/activate

          echo "Installing Python dependencies..."
          pip install --upgrade pip -q
          pip install -r requirements.txt -q
          pip install gunicorn -q

          echo "Checking database integrity..."
          python scripts/check_and_migrate_db.py

          echo "Restarting service $SERVICENAME..."
          echo "$RUNNER_PASSWORD" | sudo -S systemctl restart "$SERVICENAME"
          
          sleep 2
          
          if echo "$RUNNER_PASSWORD" | sudo -S systemctl is-active --quiet "$SERVICENAME"; then
            echo "✓ Service is running"
            echo "$RUNNER_PASSWORD" | sudo -S systemctl status "$SERVICENAME" --no-pager --lines=3
          else
            echo "✗ Service failed to start"
            echo "$RUNNER_PASSWORD" | sudo -S systemctl status "$SERVICENAME" --no-pager --lines=10
            exit 1
          fi

          echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
          echo "✓ Deployment completed!"
          echo "  Visit: https://$HOST"
          echo "  Working directory: $WORKDIR"
          echo "  Git commit: $(git rev-parse --short HEAD)"
          echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"